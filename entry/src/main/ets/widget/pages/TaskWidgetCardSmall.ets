import { WidgetData, WidgetTaskItem } from '../model/WidgetData';

@Entry
@Component
struct TaskWidgetCardSmall {
  @LocalStorageProp('widgetData') data: WidgetData = new WidgetData();

  // --- È¢úËâ≤ËµÑÊ∫ê ---
  readonly COLOR_ACCENT: Resource = $r('app.color.accent');
  readonly COLOR_BRAND: Resource = $r('app.color.brand');
  readonly COLOR_WIDGET_BG_START: Resource = $r('app.color.widget_bg_grad_start');
  readonly COLOR_WIDGET_BG_END: Resource = $r('app.color.widget_bg_grad_end');

  readonly COLOR_ITEM_BG: Resource = $r('app.color.widget_item_bg');
  // Ëá™ÂÆö‰πâËÉåÊôØ‰∏ãÁöÑÂçäÈÄèÊòé Item ËÉåÊôØ
  readonly COLOR_SEMI_ITEM_BG: ResourceColor = '#99000000';
  readonly COLOR_SEMI_WHITE_BG: ResourceColor = '#99FFFFFF';

  readonly FONT_PRIMARY: Resource = $r('app.color.font_primary');
  readonly FONT_SECONDARY: Resource = $r('app.color.font_secondary');

  /**
   * Âà§Êñ≠ÊòØÂê¶‰ΩøÁî®‰∫ÜËá™ÂÆö‰πâËÉåÊôØ
   */
  isCustomBg(): boolean {
    return !!(this.data.backgroundImage && this.data.backgroundImage.length > 0);
  }

  /**
   * Âà§Êñ≠ÊòØÂê¶‰ΩøÁî®ÁôΩËâ≤ÊñáÂ≠óÔºàÊ†πÊçÆÂõæÁâáÂàÜÊûêÁªìÊûúÔºâ
   */
  isWhiteText(): boolean {
    if (!this.data.backgroundImage) return false;
    return this.data.isWhiteText;
  }

  /**
   * Ëé∑Âèñ Item ËÉåÊôØÈ¢úËâ≤
   */
  getItemBgColor(): ResourceColor {
    if (this.data.backgroundImage && this.data.backgroundImage.length > 0) {
      if (this.isWhiteText()) {
        return this.COLOR_SEMI_ITEM_BG; // ÂçäÈÄèÊòéÈªë
      } else {
        return this.COLOR_SEMI_WHITE_BG; // ÂçäÈÄèÊòéÁôΩ
      }
    }
    return this.COLOR_ITEM_BG;
  }

  /**
   * Ëé∑Âèñ‰∏ªË¶ÅÊñáÂ≠óÈ¢úËâ≤
   */
  getPrimaryFontColor(): ResourceColor {
    if (this.data.backgroundImage) {
      return this.isWhiteText() ? Color.White : '#E6000000';
    }
    return this.FONT_PRIMARY;
  }

  /**
   * Ëé∑ÂèñÊ¨°Ë¶ÅÊñáÂ≠óÈ¢úËâ≤
   */
  getSecondaryFontColor(): ResourceColor {
    if (this.data.backgroundImage) {
      return this.isWhiteText() ? '#CCFFFFFF' : '#99000000';
    }
    return this.FONT_SECONDARY;
  }

  aboutToAppear() {
    console.info(`[TaskWidgetCardSmall] Initialized.`);
  }

  build() {
    Stack() {
      // --- 1. ËÉåÊôØÂ±Ç ---
      if (this.data.backgroundImage && this.data.backgroundImage.length > 0) {
        // A. Ëá™ÂÆö‰πâËÉåÊôØÂõæÁâá (‰øùÊåÅ‰∏çÂèò)
        Image(this.data.backgroundImage)
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
      } else {
        // B. ÈªòËÆ§Ê∏êÂèòËÉåÊôØ + Ê∞¥Ê≥¢Á∫πÊïàÊûú (‰øÆÊîπÂ§Ñ)
        Stack() {
          // 1.1 Âü∫Á°ÄÊ∏êÂèòÂ∫ïËâ≤
          Rect()
            .width('100%')
            .height('100%')
            .fill(this.COLOR_WIDGET_BG_START)
            .linearGradient({
              angle: 135,
              colors: [
                [this.COLOR_WIDGET_BG_START, 0.0],
                [this.COLOR_WIDGET_BG_END, 1.0]
              ]
            })

          // 1.2 Ê≥¢Á∫π - Â§ñÂúà (Â§ßÔºåÊûÅÊ∑°)
          Circle()
            .width(200) // 2x2 Â∞∫ÂØ∏ËæÉÂ§ßÔºåÂúÜÂúàÂèØ‰ª•ÁîªÂ§ß‰∏ÄÁÇπ
            .height(200)
            .fill(this.COLOR_BRAND)
            .opacity(0.03) // ÈùûÂ∏∏Ê∑°Ôºå‰Ωú‰∏∫ËÉåÊôØÊ∞õÂõ¥
            .position({ x: '30%', y: '-20%' }) // ‰ªéÂè≥‰∏äËßíÊôïÂºÄ

          // 1.3 Ê≥¢Á∫π - ‰∏≠Âúà (Á®çÂ∞èÔºåÁ®çÊòæ)
          Circle()
            .width(140)
            .height(140)
            .fill(this.COLOR_BRAND)
            .opacity(0.06)
            .position({ x: '55%', y: '-5%' })
        }
        .width('100%')
        .height('100%')
      }

      // --- 2. ÂÜÖÂÆπÂ±Ç (‰øùÊåÅ‰∏çÂèò) ---
      Column() {
        // --- È°∂ÈÉ®Ê†è ---
        Row() {
          Image($r('app.media.icon'))
            .width(18)
            .height(18)
            .borderRadius(4)
            .margin({ right: 6 })

          Text("Deadliner")
            .fontSize(13)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getPrimaryFontColor())
            .layoutWeight(1)
            .maxLines(1)
            .textShadow(this.data.backgroundImage ? { radius: 2, color: '#40000000' } : undefined)

          if (this.data.totalCount > 0) {
            Text(`${this.data.totalCount}`)
              .fontSize(10)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.data.totalCount > 3 ? this.COLOR_ACCENT : this.COLOR_BRAND)
              .backgroundColor(this.getItemBgColor())
              .padding({ left: 5, right: 5, top: 1, bottom: 1 })
              .borderRadius(6)
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)

        // --- ‰ªªÂä°ÂàóË°® ---
        if (this.data.tasks.length === 0) {
          this.EmptyState()
        } else {
          List({ space: 6 }) {
            ForEach(this.data.tasks.slice(0, 3), (item: WidgetTaskItem) => {
              ListItem() {
                this.CompactTaskItem(item)
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
          .margin({ top: 8 })
        }
      }
      .width('100%')
      .height('100%')
      .padding(10)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      postCardAction(this, {
        action: 'router',
        abilityName: 'EntryAbility',
        params: { target: 'main' }
      });
    })
  }

  @Builder
  CompactTaskItem(item: WidgetTaskItem) {
    Row() {
      // Â∑¶‰æßÊåáÁ§∫Êù°
      Column()
        .width(3)
        .height(12)
        .backgroundColor(item.isUrgent ? this.COLOR_ACCENT : this.COLOR_BRAND)
        .borderRadius(1.5)
        .margin({ right: 6 })

      // Ê†áÈ¢ò
      Text(item.title)
        .fontSize(12)
        .fontColor(this.getPrimaryFontColor())
        .fontWeight(item.isUrgent ? FontWeight.Medium : FontWeight.Normal)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)

      // Êó∂Èó¥
      Text(item.timeDesc)
        .fontSize(10)
        .fontColor(item.isUrgent ? this.COLOR_ACCENT : this.getSecondaryFontColor())
        .fontWeight(item.isUrgent ? FontWeight.Medium : FontWeight.Normal)
        .margin({ left: 4 })
        .maxLines(1)
        .flexShrink(0)
    }
    .width('100%')
    .height(30)
    .backgroundColor(this.getItemBgColor())
    .borderRadius(8)
    .padding({ left: 6, right: 8 })
    .alignItems(VerticalAlign.Center)
    .border({
      width: (item.isUrgent && !this.data.backgroundImage) ? 1 : 0,
      color: this.COLOR_ACCENT
    })
  }

  @Builder
  EmptyState() {
    Column() {
      Text('üéâ')
        .fontSize(30)
        .margin({ bottom: 4 })
        .textShadow(this.data.backgroundImage ? { radius: 10, color: '#80FFFFFF' } : undefined)

      Text("ÂÖ®ÈÉ®ÊêûÂÆö")
        .fontSize(12)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.FONT_PRIMARY)
        .opacity(0.8)
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .width('100%')
  }
}

@Builder
export function TaskWidgetCardSmallPreviewBuilder() {
  TaskWidgetCardSmall()
    .borderRadius(20)
    .clip(true)
    .width(150)
    .height(150)
}
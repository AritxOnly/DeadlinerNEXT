import { WidgetData, WidgetTaskItem } from '../model/WidgetData';

@Entry
@Component
struct TaskWidgetCardSmall {
  @LocalStorageProp('widgetData') data: WidgetData = new WidgetData();

  // é¢œè‰²èµ„æº
  readonly COLOR_ACCENT: Resource = $r('app.color.accent');
  readonly COLOR_BRAND: Resource = $r('app.color.brand');
  readonly COLOR_WIDGET_BG_START: Resource = $r('app.color.widget_bg_grad_start');
  readonly COLOR_WIDGET_BG_END: Resource = $r('app.color.widget_bg_grad_end');
  readonly COLOR_ITEM_BG: Resource = $r('app.color.widget_item_bg');

  readonly FONT_PRIMARY: Resource = $r('app.color.font_primary');
  readonly FONT_SECONDARY: Resource = $r('app.color.font_secondary');

  build() {
    Stack() {
      // 1. èƒŒæ™¯å±‚
      Rect()
        .width('100%')
        .height('100%')
        .fill(this.COLOR_WIDGET_BG_START)
        .linearGradient({
          angle: 135,
          colors: [
            [this.COLOR_WIDGET_BG_START, 0.0],
            [this.COLOR_WIDGET_BG_END, 1.0]
          ]
        })

      // 2. å†…å®¹å±‚
      Column() {
        // --- é¡¶éƒ¨æ  ---
        Row() {
          Image($r('app.media.icon'))
            .width(16) // [è°ƒæ•´] ç¼©å°å›¾æ ‡ä»¥èŠ‚çœç©ºé—´
            .height(16)
            .borderRadius(4)
            .margin({ right: 6 })

          Text("Deadliner")
            .fontSize(12) // [è°ƒæ•´] ä¿æŒç´§å‡‘å­—ä½“
            .fontWeight(FontWeight.Bold)
            .fontColor(this.FONT_PRIMARY)
            .layoutWeight(1)
            .maxLines(1)

          if (this.data.totalCount > 0) {
            Text(`${this.data.totalCount}`)
              .fontSize(10)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.data.totalCount > 3 ? this.COLOR_ACCENT : this.COLOR_BRAND)
              .backgroundColor(this.COLOR_ITEM_BG)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 8 })

        // --- ä»»åŠ¡åˆ—è¡¨ ---
        if (this.data.tasks.length === 0) {
          this.EmptyState()
        } else {
          List({ space: 3 }) {
            ForEach(this.data.tasks.slice(0, 3), (item: WidgetTaskItem) => {
              ListItem() {
                this.CompactTaskItem(item)
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .padding(10)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      postCardAction(this, {
        action: 'router',
        abilityName: 'EntryAbility',
        params: { target: 'main' }
      });
    })
  }

  @Builder
  CompactTaskItem(item: WidgetTaskItem) {
    Row() {
      // å·¦ä¾§æŒ‡ç¤ºæ¡
      Column()
        .width(3) // [è°ƒæ•´] ç¨å¾®å˜ç»†ä¸€ç‚¹ç‚¹ï¼Œæ˜¾å¾—ç²¾è‡´
        .height(12)
        .backgroundColor(item.isUrgent ? this.COLOR_ACCENT : this.COLOR_BRAND)
        .borderRadius(1.5)
        .margin({ right: 6 })

      // æ ‡é¢˜
      Text(item.title)
        .fontSize(12) // [è°ƒæ•´] å­—ä½“æ”¹å› 12ï¼Œé˜²æ­¢æ¢è¡Œæ’‘å¼€é«˜åº¦
        .fontColor(this.FONT_PRIMARY)
        .fontWeight(item.isUrgent ? FontWeight.Medium : FontWeight.Normal)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)

      // æ—¶é—´
      Text(item.timeDesc)
        .fontSize(10)
        .fontColor(item.isUrgent ? this.COLOR_ACCENT : this.FONT_SECONDARY)
        .fontWeight(item.isUrgent ? FontWeight.Medium : FontWeight.Normal)
        .margin({ left: 4 })
        .maxLines(1)
        .flexShrink(0)
    }
    .width('100%')
    .height(32)
    .backgroundColor(this.COLOR_ITEM_BG)
    .borderRadius(8)
    .padding({ left: 6, right: 8 })
    .alignItems(VerticalAlign.Center)
    .border({
      width: item.isUrgent ? 1 : 0,
      color: this.COLOR_ACCENT
    })
  }

  @Builder
  EmptyState() {
    Column() {
      Text('ğŸ‰')
        .fontSize(28) // Emoji å¯ä»¥ç¨å¾®å¤§ä¸€ç‚¹ï¼Œè§†è§‰ä¸Šç­‰äº 24vp çš„å›¾æ ‡
        .opacity(0.8) // ç¨å¾®åŠ ä¸€ç‚¹é€æ˜åº¦ï¼Œä¸é‚£ä¹ˆåˆºçœ¼
        .margin({ bottom: 2 })

      Text("æå®šï¼")
        .fontSize(12)
        .fontColor(this.FONT_SECONDARY)
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .width('100%')
  }
}
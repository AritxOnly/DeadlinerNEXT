import { WidgetData, WidgetTaskItem } from '../model/WidgetData';

@Entry
@Component
struct TaskWidgetCardSmall {
  @LocalStorageProp('widgetData') data: WidgetData = new WidgetData();

  // --- é¢œè‰²èµ„æº ---
  readonly COLOR_ACCENT: Resource = $r('app.color.accent');
  readonly COLOR_BRAND: Resource = $r('app.color.brand');
  readonly COLOR_WIDGET_BG_START: Resource = $r('app.color.widget_bg_grad_start');
  readonly COLOR_WIDGET_BG_END: Resource = $r('app.color.widget_bg_grad_end');

  readonly COLOR_ITEM_BG: Resource = $r('app.color.widget_item_bg');
  // è‡ªå®šä¹‰èƒŒæ™¯ä¸‹çš„åŠé€æ˜ Item èƒŒæ™¯
  readonly COLOR_SEMI_ITEM_BG: ResourceColor = '#99000000';
  readonly COLOR_SEMI_WHITE_BG: ResourceColor = '#99FFFFFF';

  readonly FONT_PRIMARY: Resource = $r('app.color.font_primary');
  readonly FONT_SECONDARY: Resource = $r('app.color.font_secondary');

  /**
   * åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†è‡ªå®šä¹‰èƒŒæ™¯
   */
  isCustomBg(): boolean {
    return !!(this.data.backgroundImage && this.data.backgroundImage.length > 0);
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç™½è‰²æ–‡å­—ï¼ˆæ ¹æ®å›¾ç‰‡åˆ†æç»“æœï¼‰
   */
  isWhiteText(): boolean {
    // å¦‚æœæ²¡æœ‰èƒŒæ™¯å›¾ï¼Œé»˜è®¤é€»è¾‘ç”±åŸå…ˆä»£ç å†³å®šï¼ˆæ¯”å¦‚é»˜è®¤æ¸å˜è‰²èƒŒæ™¯æ¯”è¾ƒäº®ï¼Œå¯èƒ½ç”¨é»‘è‰²å­—ï¼‰
    if (!this.data.backgroundImage) return false;
    return this.data.isWhiteText;
  }

  /**
   * è·å– Item èƒŒæ™¯é¢œè‰²
   * é€»è¾‘ï¼š
   * 1. é»˜è®¤æ— å›¾ï¼šç”¨åŸå…ˆçš„å®è‰²èƒŒæ™¯
   * 2. æ·±è‰²å›¾(ç™½å­—)ï¼šç”¨åŠé€æ˜é»‘åº•
   * 3. æµ…è‰²å›¾(é»‘å­—)ï¼šç”¨åŠé€æ˜ç™½åº•ï¼Œå¢åŠ å¯¹æ¯”åº¦
   */
  getItemBgColor(): ResourceColor {
    if (this.data.backgroundImage && this.data.backgroundImage.length > 0) {
      if (this.isWhiteText()) {
        return this.COLOR_SEMI_ITEM_BG; // åŠé€æ˜é»‘
      } else {
        return this.COLOR_SEMI_WHITE_BG; // åŠé€æ˜ç™½
      }
    }
    return this.COLOR_ITEM_BG;
  }

  /**
   * è·å–ä¸»è¦æ–‡å­—é¢œè‰²
   */
  getPrimaryFontColor(): ResourceColor {
    if (this.data.backgroundImage) {
      return this.isWhiteText() ? Color.White : '#E6000000'; // ç™½ æˆ– æ·±é»‘
    }
    return this.FONT_PRIMARY;
  }

  /**
   * è·å–æ¬¡è¦æ–‡å­—é¢œè‰²
   */
  getSecondaryFontColor(): ResourceColor {
    if (this.data.backgroundImage) {
      return this.isWhiteText() ? '#CCFFFFFF' : '#99000000';
    }
    return this.FONT_SECONDARY;
  }

  /**
   * è°ƒè¯•æ—¥å¿—
   */
  aboutToAppear() {
    console.info(`[TaskWidgetCardSmall] Initialized.`);
    console.info(`[TaskWidgetCardSmall] Tasks count: ${this.data.tasks.length}`);
    console.info(`[TaskWidgetCardSmall] BG Image Path: ${this.data.backgroundImage}`);

    if (this.data.backgroundImage) {
      console.info(`[TaskWidgetCardSmall] BG Image Length: ${this.data.backgroundImage.length}`);
    } else {
      console.info(`[TaskWidgetCardSmall] No Background Image set.`);
    }
  }

  build() {
    Stack() {
      // --- 1. èƒŒæ™¯å±‚ ---
      if (this.data.backgroundImage && this.data.backgroundImage.length > 0) {
        Image(this.data.backgroundImage)
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
      } else {
        Rect()
          .width('100%')
          .height('100%')
          .fill(this.COLOR_WIDGET_BG_START)
          .linearGradient({
            angle: 135,
            colors: [
              [this.COLOR_WIDGET_BG_START, 0.0],
              [this.COLOR_WIDGET_BG_END, 1.0]
            ]
          })
      }

      // --- 2. å†…å®¹å±‚ ---
      Column() {
        // --- é¡¶éƒ¨æ  ---
        Row() {
          // Logo
          Image($r('app.media.icon'))
            .width(18) // ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ï¼Œæ›´æ¸…æ™°
            .height(18)
            .borderRadius(4)
            .margin({ right: 6 })

          // App Name
          Text("Deadliner")
            .fontSize(13)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getPrimaryFontColor())
            .layoutWeight(1)
            .maxLines(1)
            // è‡ªå®šä¹‰èƒŒæ™¯ä¸‹åŠ é˜´å½±
            .textShadow(this.data.backgroundImage ? { radius: 2, color: '#40000000' } : undefined)

          // Count Badge
          if (this.data.totalCount > 0) {
            Text(`${this.data.totalCount}`)
              .fontSize(10)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.data.totalCount > 3 ? this.COLOR_ACCENT : this.COLOR_BRAND)
              .backgroundColor(this.getItemBgColor())
              .padding({ left: 5, right: 5, top: 1, bottom: 1 }) // ç¨å¾®å‡å°å†…è¾¹è·ï¼Œé˜²æ­¢æ’‘å¤ªé«˜
              .borderRadius(6)
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        // å»æ‰äº† marginï¼Œä¾é çˆ¶å®¹å™¨ padding

        // --- ä»»åŠ¡åˆ—è¡¨ ---
        if (this.data.tasks.length === 0) {
          this.EmptyState()
        } else {
          List({ space: 6 }) {
            ForEach(this.data.tasks.slice(0, 3), (item: WidgetTaskItem) => {
              ListItem() {
                this.CompactTaskItem(item)
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
          .margin({ top: 8 })
        }
      }
      .width('100%')
      .height('100%')
      .padding(10)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      postCardAction(this, {
        action: 'router',
        abilityName: 'EntryAbility',
        params: { target: 'main' }
      });
    })
  }

  @Builder
  CompactTaskItem(item: WidgetTaskItem) {
    Row() {
      // å·¦ä¾§æŒ‡ç¤ºæ¡
      Column()
        .width(3)
        .height(12)
        .backgroundColor(item.isUrgent ? this.COLOR_ACCENT : this.COLOR_BRAND)
        .borderRadius(1.5)
        .margin({ right: 6 })

      // æ ‡é¢˜
      Text(item.title)
        .fontSize(12)
        .fontColor(this.getPrimaryFontColor())
        .fontWeight(item.isUrgent ? FontWeight.Medium : FontWeight.Normal)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)

      // æ—¶é—´
      Text(item.timeDesc)
        .fontSize(10)
        .fontColor(item.isUrgent ? this.COLOR_ACCENT : this.getSecondaryFontColor())
        .fontWeight(item.isUrgent ? FontWeight.Medium : FontWeight.Normal)
        .margin({ left: 4 })
        .maxLines(1)
        .flexShrink(0)
    }
    .width('100%')
    .height(30)
    .backgroundColor(this.getItemBgColor())
    .borderRadius(8)
    .padding({ left: 6, right: 8 })
    .alignItems(VerticalAlign.Center)
    // åªæœ‰ç´§æ€¥ä¸”éè‡ªå®šä¹‰èƒŒæ™¯æ—¶æ˜¾ç¤ºè¾¹æ¡†
    .border({
      width: (item.isUrgent && !this.data.backgroundImage) ? 1 : 0,
      color: this.COLOR_ACCENT
    })
  }

  @Builder
  EmptyState() {
    Column() {
      Text('ğŸ‰')
        .fontSize(30)
        .margin({ bottom: 4 })
        .textShadow(this.data.backgroundImage ? { radius: 10, color: '#80FFFFFF' } : undefined)

      Text("å…¨éƒ¨æå®š")
        .fontSize(12)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.FONT_PRIMARY)
        .opacity(0.8)
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .width('100%')
  }
}

@Builder
export function TaskWidgetCardSmallPreviewBuilder() {
  TaskWidgetCardSmall()
    .borderRadius(24)
    .clip(true)
}
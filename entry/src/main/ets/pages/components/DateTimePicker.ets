import { ComponentContent, promptAction } from '@kit.ArkUI';

// 1. å®šä¹‰å‚æ•°æŽ¥å£
class DateTimeDialogParams {
  selectedDate: Date = new Date();
  onAccept: (date: Date) => void = () => {};
  close: () => void = () => {};
}

// 2. æ ¸å¿ƒç»„ä»¶ï¼šå¤„ç†çŠ¶æ€è”åŠ¨
@Component
struct DateTimeContent {
  // æŽ¥æ”¶åˆå§‹å‚æ•°
  @Prop initialDate: Date = new Date();
  onAccept: (date: Date) => void = () => {};
  close: () => void = () => {};

  // å†…éƒ¨çŠ¶æ€ï¼Œç”¨äºŽé©±åŠ¨æ ‡é¢˜å’Œé€‰æ‹©å™¨è”åŠ¨
  @State currentDate: Date = new Date();

  aboutToAppear() {
    // åˆå§‹åŒ–å†…éƒ¨çŠ¶æ€
    this.currentDate = new Date(this.initialDate);
  }

  // è¾…åŠ©æ–¹æ³•ï¼šèŽ·å–æ ¼å¼åŒ–çš„æ—¥æœŸæ ‡é¢˜
  private getTitle(date: Date): string {
    const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    // æ ¼å¼ï¼š2026å¹´1æœˆ3æ—¥ æ˜ŸæœŸå…­
    return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${weekDays[date.getDay()]}`;
  }

  build() {
    Column() {
      // --- æ ‡é¢˜æ  (ä¿®æ”¹ç‚¹2ï¼šå±…ä¸­ + åŠ¨æ€æ—¥æœŸ) ---
      Row() {
        Text(this.getTitle(this.currentDate)) // ç»‘å®š @State
          .fontSize(18) // ç¨å¾®è°ƒå°ä¸€ç‚¹ç‚¹çœ‹èµ·æ¥æ›´ç²¾è‡´
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Black)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center) // å±…ä¸­å¯¹é½
      .padding({ top: 24, bottom: 16 })

      // --- æ ¸å¿ƒé€‰æ‹©åŒº ---
      Row() {
        // å·¦ä¾§ï¼šæ—¥æœŸé€‰æ‹©å™¨
        DatePicker({
          start: new Date('2000-1-1'),
          end: new Date('2100-12-31'),
          selected: this.currentDate // ç»‘å®šçŠ¶æ€
        })
          .onDateChange((value: Date) => {
            // æ›´æ–°çŠ¶æ€ï¼Œè§¦å‘æ ‡é¢˜é‡ç»˜
            this.currentDate.setFullYear(value.getFullYear());
            this.currentDate.setMonth(value.getMonth());
            this.currentDate.setDate(value.getDate());
            // é‡æ–°èµ‹å€¼ç»™è‡ªèº«ä»¥è§¦å‘ @State æ›´æ–°æœºåˆ¶ (å¯¹è±¡å±žæ€§å˜æ›´æœ‰æ—¶éœ€è¦)
            this.currentDate = new Date(this.currentDate);
          })
          .layoutWeight(3)
          .height(220)
          // ðŸ”¥ ä¿®æ”¹ç‚¹1ï¼šé€‰ä¸­é¡¹é¢œè‰²æ”¹ä¸º Brand é¢œè‰²
          .selectedTextStyle({
            color: $r('app.color.brand'),
            font: { weight: FontWeight.Medium, size: 18 }
          })

        // å³ä¾§ï¼šæ—¶é—´é€‰æ‹©å™¨
        TimePicker({
          selected: this.currentDate // ç»‘å®šçŠ¶æ€
        })
          .useMilitaryTime(true)
          .onChange((value: TimePickerResult) => {
            this.currentDate.setHours(value.hour);
            this.currentDate.setMinutes(value.minute);
            this.currentDate = new Date(this.currentDate);
          })
          .layoutWeight(2)
          .height(220)
          // ðŸ”¥ ä¿®æ”¹ç‚¹1ï¼šé€‰ä¸­é¡¹é¢œè‰²æ”¹ä¸º Brand é¢œè‰²
          .selectedTextStyle({
            color: $r('app.color.brand'),
            font: { weight: FontWeight.Medium, size: 18 }
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })

      // --- åº•éƒ¨æŒ‰é’®æ  ---
      Row() {
        Button("å–æ¶ˆ")
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.brand')) // æŒ‰é’®ä¹Ÿä¿æŒ Brand é¢œè‰²
          .onClick(() => {
            this.close();
          })
          .layoutWeight(1)

        Divider().vertical(true).height(24).color(Color.Gray).opacity(0.3)

        Button("ç¡®å®š")
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.brand')) // æŒ‰é’®ä¹Ÿä¿æŒ Brand é¢œè‰²
          .onClick(() => {
            this.onAccept(this.currentDate);
            this.close();
          })
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ bottom: 16, top: 16 })
    }
    .padding({ left: 8, right: 8 })
    .width('95%')
    .borderRadius(36)
    .backgroundBlurStyle(BlurStyle.Regular)
  }
}

// 3. å…¨å±€ Builder åŒ…è£…å™¨ (ä»…è´Ÿè´£å®žä¾‹åŒ–ç»„ä»¶)
@Builder
function DateTimeBuilderWrapper(params: DateTimeDialogParams) {
  DateTimeContent({
    initialDate: params.selectedDate,
    onAccept: params.onAccept,
    close: params.close
  })
}

// 4. é™æ€å·¥å…·ç±» (ä¿æŒä¸å˜)
interface DateTimePickerOptions {
  selected?: Date;
  onAccept: (date: Date) => void;
}

export class DateTimePicker {
  static show(context: UIContext, options: DateTimePickerOptions) {
    const params = new DateTimeDialogParams();
    params.selectedDate = options.selected ? new Date(options.selected) : new Date();
    params.onAccept = options.onAccept;

    // ä½¿ç”¨ Wrapper Builder
    const contentNode = new ComponentContent(context, wrapBuilder(DateTimeBuilderWrapper), params);

    params.close = () => {
      const prompt = context.getPromptAction();
      prompt.closeCustomDialog(contentNode);
    };

    const prompt = context.getPromptAction();
    prompt.openCustomDialog(contentNode, {
      alignment: DialogAlignment.Center,
      autoCancel: true,
      isModal: true,
      onWillDismiss: (dismissDialogAction: DismissDialogAction) => {
        if (dismissDialogAction.reason == DismissReason.TOUCH_OUTSIDE) {
          dismissDialogAction.dismiss()
        }
      }
    });
  }
}
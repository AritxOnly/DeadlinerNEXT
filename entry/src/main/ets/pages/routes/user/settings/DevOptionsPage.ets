import { HdsNavDestination, HdsNavDestinationAttribute } from "@hms.hds.hdsBaseComponent"; // æ ¹æ®ä½ çš„å®é™… HDS è·¯å¾„è°ƒæ•´
import { notificationManager } from "@kit.NotificationKit";
import { promptAction } from "@kit.ArkUI";
import { reminderAgentManager } from "@kit.BackgroundTasksKit";
import { BusinessError } from "@kit.BasicServicesKit";
import { ReminderUtils } from "../../../../utils/notification/ReminderUtils";

@Builder
export function DevOptionsBuilder(name: string, param: Object) {
  DevOptionsPage()
}

@Component
export struct DevOptionsPage {

  // è¾…åŠ©æ–¹æ³•ï¼šç”Ÿæˆ toast
  private toast(msg: string) {
    promptAction.showToast({ message: msg, duration: 2000 });
  }

  build() {
    HdsNavDestination() {
      Scroll() {
        Column({ space: 12 }) {

          // =========================================================
          // 0. æ¸…ç†ç¯å¢ƒ
          // =========================================================
          Button('ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æé†’ (Reset)')
            .backgroundColor('#D32F2F') // çº¢è‰²è­¦å‘Šè‰²
            .width('90%')
            .height(50)
            .onClick(async () => {
              try {
                await reminderAgentManager.cancelAllReminders();
                this.toast('å·²æ¸…ç©ºæ‰€æœ‰åå°æé†’');
                console.info('[Dev] All reminders canceled.');
              } catch (e) {
                this.toast(`æ¸…ç©ºå¤±è´¥: ${JSON.stringify(e)}`);
              }
            })

          Divider().padding({ top: 10, bottom: 10 })

          // =========================================================
          // 1. å•å…ƒæµ‹è¯•ï¼šå•æ¬¡ DDL (Calendar)
          // =========================================================
          Text("å•å…ƒæµ‹è¯• A: å•æ¬¡ä»»åŠ¡ (DDL)")
            .fontSize(14)
            .fontColor(Color.Gray)
            .width('90%')
            .textAlign(TextAlign.Start)

          Button('ğŸ“… å‘å¸ƒ DDL (10ç§’å)')
            .backgroundColor($r('app.color.chart_green')) // å‡è®¾ä½ æœ‰è¿™ä¸ªèµ„æºï¼Œæˆ–è€…ç”¨ '#4CAF50'
            .width('90%')
            .height(60)
            .onClick(async () => {
              try {
                // 1. è®¾å®šæ—¶é—´ï¼šå½“å‰æ—¶é—´ + 10ç§’
                const targetDate = new Date();
                targetDate.setSeconds(targetDate.getSeconds() + 10);

                // 2. è°ƒç”¨ API
                console.info(`[Dev] Testing Calendar DDL. Target: ${targetDate.toLocaleTimeString()}`);
                const id = await ReminderUtils.publishCalendar(
                  "DDL æµ‹è¯•",
                  `å•æ¬¡æé†’ï¼Œåº”è¯¥åœ¨ ${targetDate.toLocaleTimeString()} è§¦å‘`,
                  targetDate
                );

                this.toast(`âœ… Calendar å‘å¸ƒæˆåŠŸ ID:${id}`);
              } catch (e) {
                const err = e as BusinessError;
                this.toast(`âŒ å¤±è´¥: ${err.code} - ${err.message}`);
                console.error(`[Dev] Calendar failed: ${JSON.stringify(err)}`);
              }
            })

          // =========================================================
          // 2. å•å…ƒæµ‹è¯•ï¼šå¾ªç¯æé†’ (Alarm)
          // =========================================================
          Text("å•å…ƒæµ‹è¯• B: å¾ªç¯/ä¹ æƒ¯ (Alarm)")
            .fontSize(14)
            .fontColor(Color.Gray)
            .width('90%')
            .textAlign(TextAlign.Start)

          Button('â° å‘å¸ƒä¹ æƒ¯ (ä¸‹ä¸€åˆ†é’Ÿ)')
            .backgroundColor('#007DFF')
            .width('90%')
            .height(60)
            .onClick(async () => {
              try {
                // 1. è®¾å®šæ—¶é—´ï¼šä¸‹ä¸€åˆ†é’Ÿçš„ 00 ç§’
                // ä¾‹å¦‚ç°åœ¨æ˜¯ 18:30:45ï¼Œè®¾å®šä¸º 18:31:00
                const now = new Date();
                const nextMinute = new Date(now.getTime() + 60 * 1000);
                const hour = nextMinute.getHours();
                const minute = nextMinute.getMinutes();

                // 2. è®¾å®šé‡å¤ï¼šæ¯å¤©
                const days = [1, 2, 3, 4, 5, 6, 7];

                console.info(`[Dev] Testing Alarm Habit. Target: ${hour}:${minute}`);

                // 3. è°ƒç”¨ API
                const id = await ReminderUtils.publishAlarm(
                  "ä¹ æƒ¯æ‰“å¡æµ‹è¯•",
                  `è¿™æ˜¯ Alarm ç±»å‹ï¼Œåº”åœ¨ ${hour}:${minute} è§¦å‘ï¼Œä¸”æ¯å¤©é‡å¤`,
                  hour,
                  minute,
                  days
                );

                this.toast(`âœ… Alarm å‘å¸ƒæˆåŠŸ ID:${id}`);
                console.info(`[Dev] Alarm published. ID: ${id}`);

              } catch (e) {
                const err = e as BusinessError;
                this.toast(`âŒ å¤±è´¥: ${err.code} - ${err.message}`);
              }
            })

          Divider().padding({ top: 10, bottom: 10 })

          // =========================================================
          // 3. çŠ¶æ€è¯Šæ–­ (ç”¨äºæŸ¥è¯)
          // =========================================================
          Button('ğŸ” æŸ¥çœ‹å½“å‰ç”Ÿæ•ˆçš„æé†’')
            .backgroundColor('#FF9800')
            .width('90%')
            .height(50)
            .onClick(async () => {
              try {
                console.info("============== DIAGNOSIS START ==============");

                // 1. æŸ¥æƒé™
                const isEnable = await notificationManager.isNotificationEnabled();
                console.info(`[Status] Notification Perm: ${isEnable}`);

                // 2. æŸ¥æ•°é‡
                const reminders = await reminderAgentManager.getValidReminders();
                console.info(`[Status] Valid Reminders Count: ${reminders.length}`);
                this.toast(`å½“å‰ç”Ÿæ•ˆæé†’æ•°: ${reminders.length}`);

                // 3. æ‰“å°è¯¦ç»†ä¿¡æ¯ (æ–¹ä¾¿åœ¨ Logcat çœ‹ç±»å‹)
                reminders.forEach((r, index) => {
                  // è¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠ r å¼ºè½¬ä¸€ä¸‹æˆ–è€…ç”¨ JSON æŸ¥çœ‹ï¼Œå› ä¸ºç±»å‹å®šä¹‰å¯èƒ½ä¸å…¨
                  // type: 1=TIMER, 2=CALENDAR, 3=ALARM
                  console.info(`[Reminder #${index}] ID:${r.notificationId} Type:${r.reminderType} Title:${r.title}`);
                  if (r.reminderType === reminderAgentManager.ReminderType.REMINDER_TYPE_ALARM) {
                    // éªŒè¯ Alarm çš„é‡å¤å±æ€§
                    const alarm = r as reminderAgentManager.ReminderRequestAlarm;
                    console.info(`   -> Alarm Days: ${JSON.stringify(alarm.daysOfWeek)} Hour:${alarm.hour}:${alarm.minute}`);
                  }
                });

                console.info("============== DIAGNOSIS END ==============");
              } catch (err) {
                this.toast(`è¯Šæ–­å¤±è´¥: ${JSON.stringify(err)}`);
              }
            })

        }
        .width('100%')
        .padding({ top: 68, bottom: 50 })
        .justifyContent(FlexAlign.Start)
      }
    }
    .titleBar({
      content: {
        title: {
          mainTitle: 'æé†’æœåŠ¡ API æµ‹è¯•'
        }
      }
    })
    .backgroundColor($r('app.color.background_primary'))
  }
}
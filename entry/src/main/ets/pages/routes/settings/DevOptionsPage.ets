import { HdsNavDestination, HdsNavDestinationAttribute } from "@hms.hds.hdsBaseComponent";
import { notificationManager } from "@kit.NotificationKit";
import { promptAction } from "@kit.ArkUI";
import { reminderAgentManager } from "@kit.BackgroundTasksKit";
import { ReminderUtils } from "../../../utils/notification/ReminderUtils";

@Builder
export function DevOptionsBuilder(name: string, param: Object) {
  DevOptionsPage()
}

const MY_BUNDLE_NAME = "com.aritxonly.deadliner"; // ä½ çš„ bundleName
const MY_ABILITY_NAME = "EntryAbility";           // ä½ çš„ abilities -> name

@Component
export struct DevOptionsPage {
  build() {
    HdsNavDestination() {
      Scroll() {
        Column({ space: 8 }) {
          Button('ğŸ“… å‘å¸ƒæŒ‡å®šæ—¶é—´æé†’ (ç¨³å®šç‰ˆ)')
            .backgroundColor($r('app.color.chart_green'))
            .width('80%')
            .height(60)
            .onClick(async () => {
              try {
                let targetDate = new Date();
                targetDate.setSeconds(targetDate.getSeconds() + 5); // 5ç§’å

                let id = await ReminderUtils.publishCalendar(
                  "å€’è®¡æ—¶æ¨¡æ‹Ÿæ—¥å†",
                  "ç¨³å¦‚è€ç‹—",
                  targetDate
                );
                promptAction.showToast({ message: `å‘å¸ƒæˆåŠŸ ID:${id}` });
              } catch (e) {
                promptAction.showToast({ message: `å¤±è´¥: ${(e as Error).message}` });
              }
            })

          Button('ğŸ”” å‘é€æ™®é€šé€šçŸ¥')
            .backgroundColor('#007DFF')
            .width('80%')
            .height(60)
            .onClick(async () => {
              try {
                // 1. æ„å»ºé€šçŸ¥è¯·æ±‚å¯¹è±¡
                // æ³¨æ„ï¼šè¿™é‡Œä¸¥æ ¼å¯¹åº” notificationManager.publish è¦æ±‚çš„ç»“æ„
                let notificationRequest: notificationManager.NotificationRequest = {
                  id: 1001,
                  content: {
                    notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
                    normal: {
                      title: "æµ‹è¯•é€šçŸ¥",
                      text: "å¦‚æœä½ çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜é€šçŸ¥å‚æ•°ä¿®æ­£æˆåŠŸäº†",
                      additionalText: "Test"
                    }
                  },
                  notificationSlotType: notificationManager.SlotType.SOCIAL_COMMUNICATION
                };

                // 2. å‘é€
                await notificationManager.publish(notificationRequest);
                console.info('[Notification] publish success');
                promptAction.showToast({ message: 'é€šçŸ¥å‘é€æˆåŠŸ' });

              } catch (err) {
                let error = err as BusinessError;
                console.error(`[Notification] Failed. Code: ${error.code}, Message: ${error.message}`);
                promptAction.showToast({ message: `å‘é€å¤±è´¥: ${error.code}` });
              }
            })

          Button('â° å‘å¸ƒå€’è®¡æ—¶æé†’')
            .backgroundColor($r('app.color.accent'))
            .width('80%')
            .height(60)
            .onClick(async () => {
              console.info("Start cancelAllReminders...");

              // 1. å…ˆå–æ¶ˆæ—§çš„ï¼ˆé˜²æ­¢å †ç§¯ï¼‰
              reminderAgentManager.cancelAllReminders((err: BusinessError) => {
                if (err) {
                  console.error("cancelAllReminders failed: " + err.code);
                  // å³ä½¿å–æ¶ˆå¤±è´¥ä¹Ÿç»§ç»­å°è¯•ï¼Œä¸‡ä¸€æ˜¯æ²¡æ•°æ®å¯¼è‡´çš„å¤±è´¥
                } else {
                  console.info("cancelAllReminders success");
                }

                // 2. å»¶æ—¶ 1 ç§’ï¼Œç­‰å¾…ç³»ç»Ÿé‡Šæ”¾é…é¢ï¼ˆå…³é”®ï¼ï¼‰
                setTimeout(async () => {
                  try {
                    let mySlotType = notificationManager.SlotType.SOCIAL_COMMUNICATION;

                    let targetReminder: reminderAgentManager.ReminderRequestTimer = {
                      reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_TIMER,
                      triggerTimeInSeconds: 10,
                      title: 'å€’è®¡æ—¶æµ‹è¯•',
                      content: 'æ—¶é—´åˆ°äº†',
                      actionButton: [
                        {
                          title: 'å…³é—­',
                          type: reminderAgentManager.ActionButtonType.ACTION_BUTTON_TYPE_CLOSE
                        }
                      ],
                      wantAgent: {
                        pkgName: 'com.aritxonly.deadliner',
                        abilityName: 'EntryAbility'
                      },
                      notificationId: 1002, // ä½¿ç”¨ä¸åŒçš„ ID
                      slotType: mySlotType  // ä¼ å…¥æ–­è¨€åçš„ç±»å‹
                    };

                    // 3. å‘å¸ƒ
                    let reminderId = await reminderAgentManager.publishReminder(targetReminder);
                    console.info('[Reminder] Publish success. ID: ' + reminderId);
                    promptAction.showToast({ message: 'æé†’å‘å¸ƒæˆåŠŸ' });

                    // 4. æŸ¥åº“éªŒè¯
                    const reminders = await reminderAgentManager.getValidReminders();
                    console.info("[Reminder] Valid count in DB: " + reminders.length);

                  } catch (err) {
                    let error = err as BusinessError;
                    console.error(`[Reminder] Failed. Code: ${error.code}, Message: ${error.message}`);

                    if (error.code == 1700002) {
                      promptAction.showToast({ message: 'âš ï¸ è¯·å¸è½½ App åé‡è¯• (é…é¢æ­»é”)' });
                    } else {
                      promptAction.showToast({ message: `æé†’å¤±è´¥: ${error.code}` });
                    }
                  }
                }, 1000); // å»¶æ—¶ç»“æŸ
              });
            })

          // =========================================================
          // 2. æ·±åº¦çŠ¶æ€è¯Šæ–­
          // =========================================================
          Button('ğŸ” æ·±åº¦çŠ¶æ€è¯Šæ–­')
            .backgroundColor('#E65100')
            .width('80%')
            .height(60)
            .onClick(async () => {
              try {
                console.info("============== DIAGNOSIS START ==============");

                const isEnable = await notificationManager.isNotificationEnabled();
                console.info(`[Diagnosis] Global Notification Enabled: ${isEnable}`);

                // ã€å…³é”®ä¿®å¤ã€‘åŠ ä¸Š as any
                const slotType = notificationManager.SlotType.SOCIAL_COMMUNICATION;
                const slot = await notificationManager.getSlot(slotType);
                console.info(`[Diagnosis] Slot (SOCIAL) enable: ${slot.enabled}`);
                console.info(`[Diagnosis] Slot (SOCIAL) level: ${slot.level}`);

                try {
                  const reminders = await reminderAgentManager.getValidReminders();
                  console.info(`[Diagnosis] Current Valid Reminders Count: ${reminders.length}`);
                } catch (e) {
                  console.error(`[Diagnosis] getValidReminders crashed: ${JSON.stringify(e)}`);
                }

                console.info("============== DIAGNOSIS END ==============");
                promptAction.showToast({ message: 'è¯Šæ–­å®Œæˆï¼Œè¯·çœ‹ Log' });

              } catch (err) {
                console.error(`[Diagnosis] Diagnosis script failed: ${JSON.stringify(err)}`);
              }
            })

          Button('ğŸ›‘ æç®€æ ¸å¿ƒæµ‹è¯•')
            .backgroundColor('#B71C1C')
            .width('80%')
            .height(60)
            .onClick(async () => {
              console.info("Start cancelAllReminders...");

              reminderAgentManager.cancelAllReminders((err: BusinessError) => {
                if (err) {
                  console.error("cancelAllReminders failed code:" + err.code + " message:" + err.message);
                  return;
                }

                console.info("cancelAllReminders callback success. Waiting for quota release...");

                setTimeout(() => {
                  console.info("Delay finished, start publishing...");

                  let timer: reminderAgentManager.ReminderRequestTimer = {
                    reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_TIMER,
                    triggerTimeInSeconds: 10
                  }

                  reminderAgentManager.publishReminder(timer, (err: BusinessError, reminderId: number) => {
                    if (err) {
                      console.error("publishReminder failed code:" + err.code + " message:" + err.message);
                    } else {
                      console.info("publishReminder success, reminderId = " + reminderId);
                    }

                    reminderAgentManager.getValidReminders().then((reminders) => {
                      console.info("getValidReminders length = " + reminders.length);
                    });
                  });
                }, 1000);
              });
            })

          Button('âœ… æµ‹è¯• - å®˜æ–¹ç¤ºä¾‹')
            .backgroundColor($r('app.color.accent'))
            .width('80%')
            .height(60)
            .onClick(async () => {
              let targetReminderAgent: reminderAgentManager.ReminderRequestTimer = {
                reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_TIMER,   // æé†’ç±»å‹ä¸ºå€’è®¡æ—¶ç±»å‹
                triggerTimeInSeconds: 10,
                actionButton: [ // è®¾ç½®å¼¹å‡ºçš„æé†’é€šçŸ¥ä¿¡æ¯ä¸Šæ˜¾ç¤ºçš„æŒ‰é’®ç±»å‹å’Œæ ‡é¢˜
                  {
                    title: 'close',
                    type: reminderAgentManager.ActionButtonType.ACTION_BUTTON_TYPE_CLOSE
                  }
                ],
                wantAgent: {     // ç‚¹å‡»æé†’é€šçŸ¥åè·³è½¬çš„ç›®æ ‡UIAbilityä¿¡æ¯
                  pkgName: 'com.aritxonly.deadliner',
                  abilityName: 'EntryAbility'
                },
                title: 'this is title', // æŒ‡æ˜æé†’æ ‡é¢˜
                content: 'this is content', // æŒ‡æ˜æé†’å†…å®¹
                expiredContent: 'this reminder has expired', // æŒ‡æ˜æé†’è¿‡æœŸåéœ€è¦æ˜¾ç¤ºçš„å†…å®¹
                notificationId: 100, // æŒ‡æ˜æé†’ä½¿ç”¨çš„é€šçŸ¥çš„IDå·ï¼Œç›¸åŒIDå·çš„æé†’ä¼šè¦†ç›–
                ringDuration: -1,
                slotType: notificationManager.SlotType.SOCIAL_COMMUNICATION // æŒ‡æ˜æé†’çš„Slotç±»å‹
              }

              reminderAgentManager.publishReminder(targetReminderAgent).then((res: number) => {
                console.info('[REMINDER]' + 'Succeeded in publishing reminder. ');
                let reminderId: number = res; // å‘å¸ƒçš„æé†’ID

                console.log('[REMINDER]' + 'REMINDER ID' + reminderId)
              }).catch((err: BusinessError) => {
                console.error(`Failed to publish reminder. Code: ${err.code}, message: ${err.message}`);
              })
            })
        }
      }
      .width('100%')
      .height('100%')
    }
    .titleBar({
      content: {
        title: {
          mainTitle: 'å¼€å‘äººå‘˜æ¨¡å¼'
        }
      }
    })
    .backgroundColor($r('app.color.background_primary'))
  }
}
import { HdsNavDestination, HdsNavDestinationAttribute } from "@hms.hds.hdsBaseComponent";
import { notificationManager } from "@kit.NotificationKit";
import { clearAllReminders, publishDeadlineReminder } from "../../../utils/notification/DeadlinerReminderUtils";
import { promptAction } from "@kit.ArkUI";
import { reminderAgentManager } from "@kit.BackgroundTasksKit";

@Builder
export function DevOptionsBuilder(name: string, param: Object) {
  DevOptionsPage()
}

const MY_BUNDLE_NAME = "com.aritxonly.deadliner"; // ä½ çš„ bundleName
const MY_ABILITY_NAME = "EntryAbility";           // ä½ çš„ abilities -> name

@Component
export struct DevOptionsPage {
  build() {
    HdsNavDestination() {
      Scroll() {
        Column() {
          Button('ğŸ›‘ æç®€æ ¸å¿ƒæµ‹è¯•')
            .backgroundColor('#B71C1C')
            .width('80%')
            .height(60)
            .onClick(async () => {
              // 1. æ¸…ç† (ä¿æŒè¿™ä¸ªå¥½ä¹ æƒ¯)
              try { await reminderAgentManager.cancelAllReminders(); } catch (e) {}

              const target = new Date();
              target.setSeconds(target.getSeconds() + 10);

              const timer: reminderAgentManager.LocalDateTime = {
                year: target.getFullYear(),
                month: target.getMonth() + 1,
                day: target.getDate(),
                hour: target.getHours(),
                minute: target.getMinutes(),
                second: target.getSeconds()
              };

              // 2. æ„é€ â€œå¹³æ°‘ç‰ˆâ€è¯·æ±‚
              const request: reminderAgentManager.ReminderRequestCalendar = {
                reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_CALENDAR,
                dateTime: timer,

                title: "Deadlineré™çº§æµ‹è¯•",
                content: "å¦‚æœè¿™æ¡èƒ½å‘ï¼Œè¯´æ˜ä¹‹å‰æ˜¯æ¸ é“ç±»å‹æƒé™ä¸å¤Ÿ",

                // ã€æ”¹åŠ¨1ã€‘åˆ é™¤ notificationIdï¼Œè®©ç³»ç»Ÿå…¨æƒæ¥ç®¡
                // notificationId: 10086,

                wantAgent: {
                  pkgName: MY_BUNDLE_NAME,
                  abilityName: MY_ABILITY_NAME
                },

                snoozeTimes: 0,
                ringDuration: 5,
                timeInterval: 0,

                // ã€æ”¹åŠ¨2ã€‘å…³é”®ï¼é™çº§ä¸º OTHER (å€¼æ˜¯3) æˆ–è€… CONTENT_INFORMATION (å€¼æ˜¯1)
                // å¾ˆå¤šéç³»ç»ŸAppåªèƒ½ç”¨è¿™ä¸ª
                slotType: notificationManager.SlotType.CONTENT_INFORMATION
              };

              try {
                console.info(`[DEBUG] æ­£åœ¨å‘å¸ƒ(ContentInfoæ¨¡å¼)...`);
                const id = await reminderAgentManager.publishReminder(request);
                console.info(`[DEBUG] ğŸ‰ æˆåŠŸ! ID: ${id}`);
                promptAction.showToast({ message: `âœ… æˆåŠŸï¼ID:${id}\nè¯·é”å±`, duration: 3000 });
              } catch (err) {
                console.error(`[DEBUG] âŒ å¤±è´¥: Code=${err.code}, Msg=${err.message}`);
                // æ‰“å°å‡ºå®Œæ•´çš„ request ä»¥ä¾¿æ ¸å¯¹
                console.error(`[DEBUG] Dump: ${JSON.stringify(request)}`);
                promptAction.showToast({ message: `å¤±è´¥: ${err.code}` });
              }
            })
        }
      }
      .width('100%')
      .height('100%')
    }
    .titleBar({
      content: {
        title: {
          mainTitle: 'å¼€å‘äººå‘˜æ¨¡å¼'
        }
      }
    })
    .backgroundColor($r('app.color.background_primary'))
  }
}
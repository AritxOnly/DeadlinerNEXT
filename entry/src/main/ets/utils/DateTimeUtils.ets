export class DateTimeUtils {

  /**
   * è”åŠ¨é€‰æ‹©å™¨ï¼šå…ˆé€‰æ—¥æœŸï¼Œå†é€‰æ—¶é—´
   * @param currentModel å½“å‰ç»‘å®šçš„æ—¶é—´å¯¹è±¡ (Date)
   * @param onFinish é€‰æ‹©å®Œæˆåçš„å›è°ƒ (è¿”å›æ–°çš„ Date)
   */
  static showDateTimePicker(currentModel: Date, onFinish: (date: Date) => void) {
    // 1. æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
    DatePickerDialog.show({
      start: new Date("2000-1-1"),
      end: new Date("2100-12-31"),
      selected: currentModel, // é»˜è®¤é€‰ä¸­å½“å‰æ—¶é—´
      onAccept: (dateValue: DatePickerResult) => {
        // 2. ç”¨æˆ·é€‰å®Œæ—¥æœŸåï¼Œæš‚å­˜å¹´æœˆæ—¥
        // æ³¨æ„ï¼šè¿™é‡Œæ„é€ ä¸€ä¸ªæ–°çš„ Date å¯¹è±¡ï¼Œæ­¤æ—¶æ—¶åˆ†ç§’é»˜è®¤æ˜¯ 00:00:00 æˆ–è€…å½“å‰æ—¶é—´ï¼Œ
        // ä¸ºäº†ä½“éªŒæ›´å¥½ï¼Œæˆ‘ä»¬å»ºè®®æŠŠ"æ—§æ—¶é—´"çš„æ—¶åˆ†ç§’å…ˆåŒæ­¥è¿‡æ¥ï¼Œ
        // è¿™æ ·æ‰“å¼€æ—¶é—´é€‰æ‹©å™¨æ—¶ï¼Œæ»šåŠ¨æ¡ä¼šåœç•™åœ¨ç”¨æˆ·ä¹‹å‰è®¾å®šçš„æ—¶é—´ï¼Œè€Œä¸æ˜¯è·³åˆ° 00:00
        const tempDate = new Date(dateValue.year!, dateValue.month!, dateValue.day!);
        tempDate.setHours(currentModel.getHours());
        tempDate.setMinutes(currentModel.getMinutes());

        // 3. ç«‹å³æ˜¾ç¤ºæ—¶é—´é€‰æ‹©å™¨
        TimePickerDialog.show({
          // ğŸ”¥ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šè¿™é‡Œå¿…é¡»ä¼  tempDate (åŒ…å«äº†æ–°æ—¥æœŸçš„å¯¹è±¡)
          // å¦‚æœä¼  currentModelï¼Œæ ‡é¢˜æ å°±ä¼šæ˜¾ç¤ºæ—§æ—¥æœŸ
          selected: tempDate,
          useMilitaryTime: true,
          onAccept: (timeValue: TimePickerResult) => {
            // 4. ç”¨æˆ·é€‰å®Œæ—¶é—´ï¼Œåˆå¹¶åˆ° tempDate
            tempDate.setHours(timeValue.hour, timeValue.minute);

            // 5. é€šè¿‡å›è°ƒè¿”å›æœ€ç»ˆç»“æœ
            onFinish(tempDate);
          },
          // ç»Ÿä¸€æ ·å¼
          backgroundBlurStyle: BlurStyle.Regular,
          selectedTextStyle: { color: $r('app.color.brand') },
          acceptButtonStyle: { fontColor: $r('app.color.brand') },
          cancelButtonStyle: { fontColor: $r('app.color.brand') }
        })
      },
      // ç»Ÿä¸€æ ·å¼
      backgroundBlurStyle: BlurStyle.Regular,
      selectedTextStyle: { color: $r('app.color.brand') },
      acceptButtonStyle: { fontColor: $r('app.color.brand') },
      cancelButtonStyle: { fontColor: $r('app.color.brand') }
    })
  }

  /**
   * æ ¼å¼åŒ–ä¸º UI æ˜¾ç¤ºç”¨çš„å­—ç¬¦ä¸²
   * æ ¼å¼: "yyyy-MM-dd HH:mm"
   */
  static formatForUI(date: Date): string {
    const pad = (n: number) => n.toString().padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  /**
   * è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´çš„ ISO æ ¼å¼å­—ç¬¦ä¸² (ç”¨äºå­˜å…¥ SQLite/RDB)
   * è§£å†³é»˜è®¤ .toISOString() æ˜¯ UTC æ—¶é—´çš„é—®é¢˜
   * æ ¼å¼: "yyyy-MM-ddTHH:mm:ss"
   */
  static toLocalISOString(d: Date): string {
    // getTimezoneOffset è¿”å›çš„æ˜¯åˆ†é’Ÿï¼Œæ¯”å¦‚ä¸œå…«åŒºæ˜¯ -480
    const offset = d.getTimezoneOffset() * 60000;
    // å‡å»åç§»é‡å¾—åˆ°æœ¬åœ°æ—¶é—´çš„æ—¶é—´æˆ³
    const local = new Date(d.getTime() - offset);
    // æˆªå–å‰19ä½ï¼Œå»æ‰ .xxxZ
    return local.toISOString().slice(0, 19);
  }

  /**
   * è§£æå„ç§æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²
   * å…¼å®¹ "yyyy-MM-dd HH:mm" å’Œ "yyyy-MM-ddTHH:mm:ss"
   */
  static parseDateString(dateStr: string): Date | null {
    if (!dateStr) return null;
    try {
      // å…¼å®¹ "2023-12-01 12:00" -> "2023-12-01T12:00:00"
      let isoStr = dateStr;
      if (dateStr.includes(' ')) {
        isoStr = dateStr.replace(' ', 'T');
      }
      // å¦‚æœæ²¡æœ‰ç§’ï¼Œè¡¥å…¨ :00 (ç®€å•çš„å®¹é”™)
      if (isoStr.split(':').length === 2) {
        isoStr += ':00';
      }

      const date = new Date(isoStr);
      if (isNaN(date.getTime())) {
        // å¦‚æœ Date æ„é€ å‡½æ•°è§£æå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨è§£æ split
        const parts = dateStr.split(/[- :T]/).filter(p => p !== '');
        if (parts.length >= 5) {
          return new Date(
            parseInt(parts[0]),
            parseInt(parts[1]) - 1, // æœˆä»½ 0-11
            parseInt(parts[2]),
            parseInt(parts[3]),
            parseInt(parts[4])
          );
        }
        return null;
      }
      return date;
    } catch (e) {
      return null;
    }
  }
}
import { reminderAgentManager } from '@kit.BackgroundTasksKit';
import { bundleManager } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';

// è·å–å½“å‰åº”ç”¨çš„ä¸» Ability åå­—
async function getMainAbilityName(): Promise<string> {
  return "EntryAbility";
}

// æ¸…ç©ºæ‰€æœ‰æé†’ï¼ˆè§£å†³ 1700002 é”™è¯¯ï¼‰
export async function clearAllReminders() {
  try {
    await reminderAgentManager.cancelAllReminders();
    console.info('[Reminder] âœ… å·²æ¸…ç©ºæ‰€æœ‰æ—§æé†’ï¼Œé…é¢å·²é‡Šæ”¾');
  } catch (error) {
    console.error(`[Reminder] æ¸…ç©ºå¤±è´¥: ${JSON.stringify(error)}`);
  }
}

export async function publishDeadlineReminder(title: string, content: string, targetTime: Date) {

  // 1. è‡ªåŠ¨è·å–æ­£ç¡®å‚æ•°
  const myPkgName = (await bundleManager.getBundleInfoForSelf(0)).name;
  const myAbilityName = await getMainAbilityName();

  // 2. æ„é€ æ—¶é—´
  const dateTime: reminderAgentManager.LocalDateTime = {
    year: targetTime.getFullYear(),
    month: targetTime.getMonth() + 1,
    day: targetTime.getDate(),
    hour: targetTime.getHours(),
    minute: targetTime.getMinutes(),
    second: targetTime.getSeconds()
  };

  // 3. å›ºå®šä¸€ä¸ª ID ç”¨äºæµ‹è¯• (é¿å…ç”Ÿæˆå¤§é‡åƒåœ¾æ•°æ®å æ»¡é…é¢)
  // å®é™…ä¸Šçº¿æ—¶å¯ä»¥ç”¨éšæœº IDï¼Œä½†æµ‹è¯•æ—¶æˆ‘ä»¬ç”¨å›ºå®šçš„ï¼Œæ–¹ä¾¿â€œè¦†ç›–â€æ—§çš„
  const TEST_ID = 88888;

  const reminderRequest: reminderAgentManager.ReminderRequestCalendar = {
    reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_CALENDAR,
    dateTime: dateTime,

    // æ ¸å¿ƒå†…å®¹
    title: title,
    content: content,
    notificationId: TEST_ID, // ä½¿ç”¨å›ºå®š IDï¼Œé˜²æ­¢çˆ†ä»“

    // å…³é”®ï¼šå®Œå…¨åŠ¨æ€è·å–çš„è·³è½¬ç›®æ ‡
    wantAgent: {
      pkgName: myPkgName,
      abilityName: myAbilityName
    },

    snoozeTimes: 0,
    ringDuration: 5,
    // ã€å…³é”®ã€‘ç§»é™¤ slotTypeï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤ï¼Œé¿å…æƒé™é—®é¢˜
  };

  console.info(`[Reminder] å‡†å¤‡å‘å¸ƒ: Pkg=${myPkgName}, Ability=${myAbilityName}, Time=${JSON.stringify(dateTime)}`);

  try {
    // 4. å…ˆå°è¯•å–æ¶ˆè¿™ä¸ªå›ºå®šçš„æµ‹è¯• ID (é˜²æ­¢é‡å¤)
    try { await reminderAgentManager.cancelReminder(TEST_ID); } catch(e) {}

    // 5. å‘å¸ƒ
    const reminderId = await reminderAgentManager.publishReminder(reminderRequest);
    console.info(`[Reminder] ğŸ‰ æˆåŠŸå‘å¸ƒ! ID: ${reminderId}`);
    return reminderId;
  } catch (error) {
    let err = error as BusinessError;
    // 1700002 = æ•°é‡è¶…é™; 401 = å‚æ•°é”™è¯¯
    console.error(`[Reminder] âŒ å¤±è´¥. Code: ${err.code}, Msg: ${err.message}`);

    // å¦‚æœè¿˜æ˜¯æŠ¥æ•°é‡è¶…é™ï¼Œå°è¯•è‡ªåŠ¨æ¸…ç†ä¸€æ¬¡å†é‡è¯•
    if (err.code === 1700002) {
      console.info('[Reminder] æ£€æµ‹åˆ°é…é¢æ»¡ï¼Œæ­£åœ¨è‡ªåŠ¨æ¸…ç†...');
      await clearAllReminders();
      // è¿™é‡Œå¯ä»¥é€’å½’é‡è¯•ä¸€æ¬¡ï¼Œæˆ–è€…è®©ç”¨æˆ·å†ç‚¹ä¸€æ¬¡æŒ‰é’®
    }
    return -1;
  }
}